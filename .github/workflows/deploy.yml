# CI/CD Pipeline — TaskFlow
# Trigger: push to main branch
# Flow: Type Check → Build Test → Deploy via SSH

name: Deploy TaskFlow

on:
  push:
    branches: [main]
  workflow_dispatch:  # ให้กด deploy มือได้จาก GitHub UI

env:
  NODE_VERSION: '20'

jobs:
  # ==========================================
  # Job 1: CI — ตรวจ code quality
  # ==========================================
  ci:
    name: CI — Type Check & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # --- Backend ---
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Generate Prisma Client
        working-directory: ./backend
        run: npx prisma generate

      - name: Backend type check
        working-directory: ./backend
        run: npx tsc --noEmit

      - name: Backend build test
        working-directory: ./backend
        run: npm run build

      # --- Frontend ---
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Frontend type check
        working-directory: ./frontend
        run: npx tsc -b --noEmit

      - name: Frontend build test
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_API_URL: http://localhost:3000/api/v1

  # ==========================================
  # Job 2: CD — Deploy to production server
  # ==========================================
  deploy:
    name: CD — Deploy to Server
    runs-on: ubuntu-latest
    needs: ci  # รอ CI ผ่านก่อน
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script_stop: true
          script: |
            cd ${{ secrets.DEPLOY_PATH || '/home/deploy/taskflow' }}

            echo "=== Pulling latest code ==="
            git pull origin main

            echo "=== Building & restarting containers ==="
            docker compose -f docker-compose.prod.yml up -d --build

            echo "=== Running Prisma db push ==="
            docker compose -f docker-compose.prod.yml exec -T backend npx prisma db push --accept-data-loss

            echo "=== Cleaning old images ==="
            docker image prune -f

            echo "=== Health check ==="
            sleep 10
            curl -sf http://localhost:4201/api/v1/health || echo "WARNING: Health check failed"

            echo "=== Deploy complete ==="
            docker compose -f docker-compose.prod.yml ps
